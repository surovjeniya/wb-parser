version: '3.7'

networks:
  infra:
    name: $INFRA_NETWORK
    driver: bridge
volumes:
  downloads:
    name: $INFRA_DOWNLOADS_VOLUME
    driver: local

services:
  nginx-service:
    image: $INFRA_NGINX_IMAGE
    container_name: $INFRA_NGINX_APP
    build: 
      context: ../nginx
      dockerfile: Dockerfile
    environment:
      - INFRA_BROWSERLESS_UPSTREAM=${INFRA_BROWSERLESS_UPSTREAM}
    ports:
      - "${INFRA_NGINX_PORT}:${INFRA_NGINX_PORT}"
    restart: unless-stopped
    networks:
     - infra
    depends_on:
      - browserless_two
      - browserless_one
      - browserless_three
      - parser-api-service

  parser-api-service:
    image: $INFRA_PARSER_API_IMAGE
    container_name: $INFRA_PARSER_API_APP
    build: 
      context: ../app
      dockerfile: Dockerfile
      target: development
    command: npm run start:dev
    restart: unless-stopped
    volumes:
      - downloads:/usr/src/app/downloads
      - ../app:/usr/src/app
    environment:
      HOST_NAME: $INFRA_PARSER_HOSTNAME
      PORT: $INFRA_PARSER_API_PORT
      NODE_ENV: production
      TZ: Europe/Moscow
    networks:
     - infra
  
  browserless_two:
    image: ${INFRA_BROWSERLESS_IMAGE}
    container_name: ${INFRA_BROWSERLESS_TWO_APP}
    build:
      context: ../browserless
      dockerfile: Dockerfile
    environment:
      - PORT=${INFRA_BROWSERLESS_TWO_PORT}
      - DEFAULT_LAUNCH_ARGS=${INFRA_BROWSERLESS_DEFAULT_ARGS}
      - PRE_REQUEST_HEALTH_CHECK=true
      - EXIT_ON_HEALTH_FAILURE=true
      - WORKSPACE_DELETE_EXPIRED=true
    restart: unless-stopped
    networks:
      - infra
    ports:
      - "${INFRA_BROWSERLESS_TWO_PORT}:${INFRA_BROWSERLESS_TWO_PORT}"

  browserless_three:
    image: ${INFRA_BROWSERLESS_IMAGE}
    container_name: ${INFRA_BROWSERLESS_THREE_APP}
    build:
      context: ../browserless
      dockerfile: Dockerfile
    environment:
      - PORT=${INFRA_BROWSERLESS_THREE_PORT}
      - DEFAULT_LAUNCH_ARGS=${INFRA_BROWSERLESS_DEFAULT_ARGS}
      - PRE_REQUEST_HEALTH_CHECK=true
      - EXIT_ON_HEALTH_FAILURE=true
      - WORKSPACE_DELETE_EXPIRED=true
    restart: unless-stopped
    networks:
      - infra
    ports:
      - "${INFRA_BROWSERLESS_THREE_PORT}:${INFRA_BROWSERLESS_THREE_PORT}"

  browserless_one:
    image: ${INFRA_BROWSERLESS_IMAGE}
    container_name: ${INFRA_BROWSERLESS_ONE_APP}
    build:
      context: ../browserless
      dockerfile: Dockerfile
    environment:
      - PORT=${INFRA_BROWSERLESS_ONE_PORT}
      - DEFAULT_LAUNCH_ARGS=${INFRA_BROWSERLESS_DEFAULT_ARGS}
      - PRE_REQUEST_HEALTH_CHECK=true
      - EXIT_ON_HEALTH_FAILURE=true
      - WORKSPACE_DELETE_EXPIRED=true
    restart: unless-stopped
    networks:
      - infra
    ports:
      - "${INFRA_BROWSERLESS_ONE_PORT}:${INFRA_BROWSERLESS_ONE_PORT}"
